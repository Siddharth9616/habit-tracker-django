{% extends 'base.html' %}
{% load custom_tags %}
{% block content %}

<!-- Add Habit Modal -->
<div class="modal fade" id="addHabitModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">â• Add New Habit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post" action="{% url 'add_habit' %}">
        {% csrf_token %}

        <div class="modal-body">
          <label class="form-label">Habit Name</label>
          <input
            type="text"
            name="name"
            class="form-control"
            placeholder="e.g. Wake up at 6 AM"
            required>
        </div>

        <div class="modal-footer">
          <button type="button"
                  class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-success">
            Save Habit
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<div class="mb-4 text-center">
  <h2 class="fw-bold">
    ğŸ‘‹ Welcome back, <span class="text-primary">{{ request.user.first_name|default:request.user.username }}</span>
  </h2>
  <p>
    Letâ€™s keep your habits strong today ğŸ’ª
  </p>
</div>


<div class="row g-4 mb-4">

  <!-- Streak -->
  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6 class="achievements-text">ğŸ”¥ Current Streak</h6>
        <h2 class="fw-bold">{{ streak }} Days</h2>
      </div>
    </div>
  </div>

  <!-- XP -->
  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6 class="achievements-text">â­ XP</h6>
        <h2 class="fw-bold">{{ xp }}</h2>
      </div>
    </div>
  </div>
 <!-- Level -->
  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6 class="achievements-text">ğŸ† Level</h6>
        <h2 class="fw-bold">{{ level }}</h2>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="achievements-text">ğŸ… Achievements</h5>

    {% if badges %}
      <ul class="list-group">
        {% for badge in badges %}
          <li class="list-group-item">{{ badge }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="achievements-text">No badges earned yet. Keep going ğŸ’ª</p>
    {% endif %}
  </div>
</div>

</div>

<form method="post">
  {% csrf_token %}

  <!-- â³ Incomplete Habits -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">â³ Remaining habits</h5>

      <button
      type="button"
       class="btn btn-sm btn-primary position-absolute"
       style="top: 15px; right: 15px;"
       data-bs-toggle="modal"
       data-bs-target="#addHabitModal">
       â• Add Habit
      </button>

      {% for habit in incomplete_habits %}
      <div class="d-flex justify-content-between align-items-center mb-2">

        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            name="habit_{{ habit.id }}"
            id="habit{{ habit.id }}"
          >
          <label class="form-check-label">
            {{ habit.name }}
          </label>
        </div>

        <div>
          <a href="{% url 'edit_habit' habit.id %}" class="btn btn-sm btn-outline-warning me-1">Edit</a>
          <a href="{% url 'delete_habit' habit.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
        </div>

      </div>
      {% empty %}
      <p class="text-muted">No pending habits ğŸ‰</p>
      {% endfor %}
    </div>

    <!-- âœ… Completed Habits -->

    <div class="card-body">
      <h5 class="mb-3 text-success">âœ… Completed Today</h5>

      {% for habit in completed_habits %}
      <div class="form-check mb-2">
        <input
          class="form-check-input"
          type="checkbox"
          checked
          name="habit_{{ habit.id }}"
          id="habit{{ habit.id }}"
        >
        <label class="form-check-label ">
          {{ habit.name }}
        </label>
      </div>
      {% empty %}
      <p class="text-muted">No habits completed yet.</p>
      {% endfor %}
    </div>

    <button class="btn btn-success">ğŸ’¾ Save Today</button>
  </div>
  
</form>





<!-- Charts -->
<div class="row g-4">

  <!-- Matplotlib -->
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">ğŸ“ˆ Monthly Progress</h5>
        <img src="{% url 'monthly_chart' %}" class="img-fluid rounded" alt="Monthly Chart">
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">ğŸ“Š Today</h5>
        <canvas id="dailyChart" height=></canvas>
      </div>
    </div>
  </div>

</div>


<canvas id="dailyChart" width="220" height="220"></canvas>

<script>
fetch("{% url 'daily_chart_data' %}")
  .then(response => response.json())
  .then(data => {

    const ctx = document.getElementById('dailyChart').getContext('2d');

    const total = data.data.reduce((a, b) => a + b, 0);
    const completed = data.data[0];
    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

    const centerText = {
      id: 'centerText',
      afterDraw(chart) {
        const { ctx, chartArea } = chart;
        ctx.save();
        ctx.font = 'bold 22px sans-serif';
        ctx.fillStyle = '#198754';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(
          `${percentage}%`,
          (chartArea.left + chartArea.right) / 2,
          (chartArea.top + chartArea.bottom) / 2
        );
        ctx.restore();
      }
    };

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: data.labels,
        datasets: [{
          data: data.data,
          backgroundColor: ['#198754', '#dee2e6'],
          borderWidth: 0
        }]
      },
      options: {
        cutout: '70%',
        animation: {
          animateRotate: true,
          animateScale: true,
          duration: 1200
        },
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      },
      plugins: [centerText]
    });

  })
  .catch(err => console.error("Daily chart error:", err));


</script>

<style>
   .btn-primary {
  border-radius: 20px;
  padding: 4px 12px;
  font-weight: 500;
}

.modal-content {
  border-radius: 16px;
}

.modal-header {
  border-bottom: none;
}

.modal-footer {
  border-top: none;
}
</style>


{% endblock %}
